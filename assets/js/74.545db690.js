(window.webpackJsonp=window.webpackJsonp||[]).push([[74],{535:function(t,a,s){"use strict";s.r(a);var e=s(29),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"yyy-preset"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#yyy-preset"}},[t._v("#")]),t._v(" yyy-preset")]),t._v(" "),s("p",[s("strong",[t._v("yyy-preset")]),t._v(" 是一个集 OPQBot + botoy 安装、管理、维护、迁移的完整预设解决方案，保持清真的工作流。")]),t._v(" "),s("p",[s("em",[t._v("yyy")]),t._v(" : "),s("ruby",[t._v("\n結城 "),s("rp",[t._v("(")]),s("rt",[s("strong",[t._v("Y")]),t._v("uuki")]),s("rp",[t._v(")")]),t._v("\n友奈 "),s("rp",[t._v("(")]),s("rt",[s("strong",[t._v("Y")]),t._v("uuna")]),s("rp",[t._v(")")]),t._v("\nは "),s("rp",[t._v("(")]),s("rt",[t._v("wa")]),s("rp",[t._v(")")]),t._v("\n勇者 "),s("rp",[t._v("(")]),s("rt",[s("strong",[t._v("Y")]),t._v("uusha")]),s("rp",[t._v(")")]),t._v("\nで "),s("rp",[t._v("(")]),s("rt",[t._v("de")]),s("rp",[t._v(")")]),t._v("\nある "),s("rp",[t._v("(")]),s("rt",[t._v("Aru")]),s("rp",[t._v(")")])])]),t._v(" "),s("h2",{attrs:{id:"before"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#before"}},[t._v("#")]),t._v(" Before")]),t._v(" "),s("h3",{attrs:{id:"知识预备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#知识预备"}},[t._v("#")]),t._v(" 知识预备")]),t._v(" "),s("p",[t._v("在开始之前：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("推荐你拥有一台 ubuntu 系统的 linux 服务器/轻量服务器/学生机，如果你是 centos 大神、氪佬、树莓派党，可选择其他运行环境。")])]),t._v(" "),s("li",[s("p",[t._v("确保你已经熟悉最基础的 linux 系统 ssh 连接，或 bt 管理面板的简单使用。")])]),t._v(" "),s("li",[s("p",[t._v("如果你是小白，请提前阅读 "),s("a",{attrs:{href:"https://docs.opqbot.com/guide/manual.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("从零开始搭建 OPQBot"),s("OutboundLink")],1),t._v(" 了解 OPQBot 的全貌。")])])]),t._v(" "),s("p",[t._v("最后，保证你有 root 权限的用户，可使用如下命令进入 root 用户：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" -i\n")])])]),s("h3",{attrs:{id:"开始准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开始准备"}},[t._v("#")]),t._v(" 开始准备")]),t._v(" "),s("p",[t._v("我们约定，之后所有的文件操作均在 "),s("code",[t._v("~/opqbot")]),t._v(" 即 "),s("code",[t._v("root/opqbot/*")]),t._v(" 下进行：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" ~/opqbot\n")])])]),s("p",[t._v("这样做的好处是避免文件分散在各处，无论何时，你都可以将此文件打包带走，进行迁移或备份。")]),t._v(" "),s("p",[t._v("在本仓库内，我们提供了一些样板结构，帮助你理解，你可以有条件的选择参考使用。")]),t._v(" "),s("p",[t._v("下文我们将介绍如何构建 OPQBot 本体与 botoy 的通信流，与日常管理的操作行为。")]),t._v(" "),s("h2",{attrs:{id:"server"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server"}},[t._v("#")]),t._v(" Server")]),t._v(" "),s("p",[t._v("OPQ 本体我们管理在 docker 内保证持续存活与端口安全。")]),t._v(" "),s("h3",{attrs:{id:"docker-base"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-base"}},[t._v("#")]),t._v(" Docker Base")]),t._v(" "),s("h4",{attrs:{id:"安装-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-docker"}},[t._v("#")]),t._v(" 安装 docker")]),t._v(" "),s("p",[t._v("你可以通过以下两个渠道安装 docker：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("bt 面板 > 软件管理 > 安装 Docker 管理器 ，之后 docker 环境就会自动安装完毕。")])]),t._v(" "),s("li",[s("p",[t._v("参考安装教程安装，如："),s("a",{attrs:{href:"https://www.runoob.com/docker/ubuntu-docker-install.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ubuntu Docker 安装"),s("OutboundLink")],1)])])]),t._v(" "),s("h4",{attrs:{id:"构建-docker-镜像"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#构建-docker-镜像"}},[t._v("#")]),t._v(" 构建 docker 镜像")]),t._v(" "),s("p",[t._v("下面构建机器人运行必备的最低限 docker 镜像，在 "),s("code",[t._v("server/docker/Dockerfile")]),t._v(" 已经准备好了构建 docker 镜像的基础文件，跳转至该目录，运行：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 构建一个叫 opqbot 的镜像，tag 标签为 base")]),t._v("\n  docker build -t opqbot:base ./\n")])])]),s("p",[t._v("构建完成后，你可以使用：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  docker images\n")])])]),s("p",[t._v("命令或在 bt docker 管理器内查看目前你拥有的镜像列表。")]),t._v(" "),s("h3",{attrs:{id:"opq-base"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#opq-base"}},[t._v("#")]),t._v(" OPQ Base")]),t._v(" "),s("h4",{attrs:{id:"准备-opq-本体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备-opq-本体"}},[t._v("#")]),t._v(" 准备 OPQ 本体")]),t._v(" "),s("p",[t._v("你可以在 OPQ 仓库的 release 处查看到目前最新的版本，并下载对应你系统的安装包，这里以最常见的 普通云服务器/学生机/轻量服务器 linux x86 为例，你应该下载：")]),t._v(" "),s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/fz6m/Private-picgo@moe-2021/img/20211102005103.png",width:"45%"}}),t._v(" "),s("p",[t._v("即 "),s("code",[t._v("amd64")]),t._v(" 的版本 （ x86 即 amd64 ）。")]),t._v(" "),s("p",[t._v("因为 OPQ 本体版本会定期更新，所以我们约定将所有下载后的压缩包存放至 "),s("code",[t._v("server/download")]),t._v(" 下，比如 "),s("code",[t._v("server/download/OPQBot_6.7.5_linux_amd64.tar.gz")]),t._v(" 。")]),t._v(" "),s("p",[t._v("之后将其解压，解压出来的文件我们约定存放至 "),s("code",[t._v("server/opq/*")]),t._v(" 内，可以看到：")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("server/opq/OPQBot")]),t._v(": 机器人本体启动二进制文件")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("server/opq/CoreConf.conf")]),t._v(": 机器人本体配置文件")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("server/opq/Plugins")]),t._v(": 存放 lua 插件的文件夹，默认内置了三个插件")])])]),t._v(" "),s("p",[t._v("在启动 OPQ 本体前我们先进行配置与收束。")]),t._v(" "),s("h4",{attrs:{id:"收束-opq-本体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#收束-opq-本体"}},[t._v("#")]),t._v(" 收束 OPQ 本体")]),t._v(" "),s("p",[t._v("有几件事情需要关注。")]),t._v(" "),s("h5",{attrs:{id:"进行配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进行配置"}},[t._v("#")]),t._v(" 进行配置")]),t._v(" "),s("p",[t._v("首先是配置，我们需要配置 OPQ 运行的 port 端口和对应的 token ，配置文件存在于 "),s("code",[t._v("server/opq/CoreConf.conf")]),t._v(" ：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("更改 "),s("code",[t._v("Port")]),t._v(" 为 "),s("code",[t._v("0.0.0.0:9527")]),t._v(" ，大部分情况 bt 面板需要 "),s("code",[t._v("8888")]),t._v(" 端口，且为了安全我们不应该使用一个容易被猜到的常见端口。")])]),t._v(" "),s("li",[s("p",[t._v("填写你的 "),s("code",[t._v("Token")]),t._v(" ，有关 "),s("code",[t._v("Token")]),t._v(" 获取可见 "),s("a",{attrs:{href:"https://docs.opqbot.com/guide/manual.html#%E7%94%B3%E8%AF%B7-token",target:"_blank",rel:"noopener noreferrer"}},[t._v("从零开始搭建OPQBot > 申请 token"),s("OutboundLink")],1)])])]),t._v(" "),s("h5",{attrs:{id:"lua-系插件的安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#lua-系插件的安全"}},[t._v("#")]),t._v(" lua 系插件的安全")]),t._v(" "),s("p",[t._v("其次是 lua 插件，由于 lua 插件是原生插件，不支持热插拔，所以每次更新功能都需要重启机器人，导致账号重新登录，这里极力不推荐使用 lua 系插件，因为每次重新登录都会对你的账号造成极不安全的风险评估，我们的建议是 OPQ 本体一经启动将运行到天荒地老，永不进行账号二次登录，全力保障账号的安全。")]),t._v(" "),s("p",[t._v("所以我们要删除默认自带含有主动操作的 lua 插件，保证所有的机器人行为由外部 client 端管控。")]),t._v(" "),s("p",[t._v("此处删除以下几个文件：")]),t._v(" "),s("ol",[s("li",[s("p",[s("code",[t._v("server/opq/Plugins/Events.lua")]),t._v(": 内含一些主动，预期之外的操作行为")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("server/opq/Plugins/Replay.lua")]),t._v(": 内含复读机")])])]),t._v(" "),s("h4",{attrs:{id:"运行-opq-本体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#运行-opq-本体"}},[t._v("#")]),t._v(" 运行 OPQ 本体")]),t._v(" "),s("p",[t._v("最后我们运行 OPQ 本体，运行：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  docker run -v /root/opqbot/server/opq:/opq -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9527")]),t._v(":9527 -d --name opq -w /opq opqbot:base ./OPQBot\n")])])]),s("p",[t._v("此时会将机器人映射到容器内，并映射端口至本地，容器名称为 "),s("code",[t._v("opq")]),t._v(" 。")]),t._v(" "),s("p",[t._v("你可以使用以下命令进行日常管理：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看目前正在运行的所有 docker 容器")]),t._v("\n  docker "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -a\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止 OPQ 本体：除非升级 OPQ 本体，否则极力不推荐此行为，给账号提升不稳定的风险指数得不偿失")]),t._v("\n  docker stop opq\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动 OPQ 本体")]),t._v("\n  docker start opq\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入容器，查看实时最后 20 行日志")]),t._v("\n  docker logs -tf opq --tail "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("\n")])])]),s("p",[t._v("OPQ 本体已经在容器内启动，我们新建一个终端，进入容器确认运行状况：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  docker logs -tf opq --tail "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v("\n")])])]),s("p",[t._v("之后打开安全组(轻量服务器没有)，打开防火墙 "),s("code",[t._v("9527")]),t._v(" 端口，访问：")]),t._v(" "),s("p",[s("code",[t._v("http://host:9527/v1/Login/GetQRcode")])]),t._v(" "),s("p",[t._v("其中 "),s("code",[t._v("host")]),t._v(" 是你服务器的外网 ip ，如果此时无法访问，但是容器内日志提示无异常，一定是你的服务器 安全组 或 防火墙 有问题。")]),t._v(" "),s("p",[t._v("最后进行扫码登录即可。")]),t._v(" "),s("h4",{attrs:{id:"升级-opq-本体"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#升级-opq-本体"}},[t._v("#")]),t._v(" 升级 OPQ 本体")]),t._v(" "),s("p",[t._v("我们约定非升级场景绝不操作 docker 容器保证账号安全，在升级时，流程如下：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("在 OPQ 仓库 release 下载最新版本的压缩包放至 "),s("code",[t._v("server/download")])])]),t._v(" "),s("li",[s("p",[t._v("停止 docker 容器运行：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  docker stop opq\n")])])])]),t._v(" "),s("li",[s("p",[t._v("解压该新版本压缩包，将其中核心启动二进制文件 "),s("code",[t._v("OPQBot")]),t._v(" 拷贝，覆盖至 "),s("code",[t._v("server/opq/OPQBot")])])]),t._v(" "),s("li",[s("p",[t._v("最后启动新版本 OPQ 本体：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  docker start opq\n")])])])])]),t._v(" "),s("p",[t._v("你会发现一经部署，永久复用，你再也不需要考虑任何 docker 相关的内容！")]),t._v(" "),s("h2",{attrs:{id:"client"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#client"}},[t._v("#")]),t._v(" Client")]),t._v(" "),s("p",[t._v("对于 client 端我们采用 botoy 进行远程控制。")]),t._v(" "),s("h3",{attrs:{id:"python-base"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#python-base"}},[t._v("#")]),t._v(" Python Base")]),t._v(" "),s("h4",{attrs:{id:"安装-python"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-python"}},[t._v("#")]),t._v(" 安装 python")]),t._v(" "),s("p",[t._v("对于 python 环境此处建议手动编译安装，流程如下：")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("访问 "),s("a",{attrs:{href:"https://www.python.org/downloads/source/",target:"_blank",rel:"noopener noreferrer"}},[t._v("python"),s("OutboundLink")],1),t._v(" 官网下载页面，下载 python3.9 系列的 linux 编译包：")]),t._v(" "),s("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/fz6m/Private-picgo@moe-2021/img/20211102012654.png",width:"40%"}})]),t._v(" "),s("li",[s("p",[t._v("上传服务器，我们约定存放于 "),s("code",[t._v("client/python")]),t._v(" 文件夹内，如 "),s("code",[t._v("client/python/Python-3.9.7.tgz")]),t._v(" 。")])]),t._v(" "),s("li",[s("p",[t._v("解压并编译安装：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 先进入该文件夹目录，运行解压命令")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf ./Python-3.9.7.tgz\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进入解压后的文件夹")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ./Python-3.9.7.tgz\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译安装，先运行")]),t._v("\n  ./configure\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 再运行")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("等待安装完成后，使用如下命令确认 python 成功安装：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  python3 --version\n")])])])]),t._v(" "),s("li",[s("p",[t._v("打开 "),s("code",[t._v("~/.bashrc")]),t._v(" 文件，在最后写入别名，方便我们后续使用：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("alias")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("python")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("python3.9\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("alias")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("pip")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("pip3.9\n")])])])]),t._v(" "),s("li",[s("p",[t._v("打开新终端，最后使用命令确认 python3.9 已成功链接：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  python --version\n")])])])])]),t._v(" "),s("p",[t._v("到此为止，我们的 python 已安装完毕。")]),t._v(" "),s("h4",{attrs:{id:"准备基础依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备基础依赖"}},[t._v("#")]),t._v(" 准备基础依赖")]),t._v(" "),s("p",[t._v("因为我们的插件繁多，我们约定将所有插件的依赖都收集存储记录于 "),s("code",[t._v("client/requirements.txt")]),t._v(" ，这样做的好处是当你迁移服务器时下次可以快速恢复环境，如 "),s("code",[t._v("requirements.txt")]),t._v(" ：")]),t._v(" "),s("div",{staticClass:"language-txt extra-class"},[s("pre",{pre:!0,attrs:{class:"language-txt"}},[s("code",[t._v("pillow\nhttpx\npathlib\nbotoy>=7\nFlask>2\npython-socketio>4,<5\nflask-socketio>4,<5\neventlet==0.32.0\nschedule\nimageio\nwordcloud\npython_dateutil\nqrcode\npycryptodome\nujson\nredis\n")])])]),s("p",[t._v("安装基础依赖的命令如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在 client 目录下运行安装所有 requirements.txt 内的依赖")]),t._v("\n  pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -i https://pypi.tuna.tsinghua.edu.cn/simple -r ./requirements.txt\n")])])]),s("p",[t._v("我们约定：")]),t._v(" "),s("ul",[s("li",[t._v("每有新的插件加入 botoy ，均勤劳的更新该文件，此时的勤劳是日后的便捷，不要因小失大")])]),t._v(" "),s("p",[t._v("准备好 python 环境后，即可开启 botoy 环境准备，若你并不知道应该先置哪些依赖，可以先安装 "),s("a",{attrs:{href:"https://github.com/opq-osc/botoy",target:"_blank",rel:"noopener noreferrer"}},[t._v("botoy"),s("OutboundLink")],1),t._v(" ，之后再向其中补充。")]),t._v(" "),s("h3",{attrs:{id:"botoy-base"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#botoy-base"}},[t._v("#")]),t._v(" Botoy Base")]),t._v(" "),s("h4",{attrs:{id:"安装-botoy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装-botoy"}},[t._v("#")]),t._v(" 安装 botoy")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  pip "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -i https://pypi.tuna.tsinghua.edu.cn/simple botoy\n")])])]),s("h4",{attrs:{id:"配置-botoy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置-botoy"}},[t._v("#")]),t._v(" 配置 botoy")]),t._v(" "),s("p",[t._v("我们约定将 botoy 客户端存放于 "),s("code",[t._v("client/botoy")]),t._v(" 内，botoy 的使用比较灵活，具体如何使用因人而异，千人千面，在我们准备的示例内，存在如下结构：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" - client\n   - botoy\n     - plugins    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 存放 botoy 的所有插件，具体使用请查看 botoy 文档说明")]),t._v("\n     - bot.py     "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# bot 主体启动入口文件")]),t._v("\n     - botoy.json "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# botoy 配置文件，与 OPQ 本体交互的端口与账号均在此处配置")]),t._v("\n")])])]),s("p",[t._v("对 "),s("code",[t._v("client/botoy/botoy.json")]),t._v(" 内的 "),s("code",[t._v("qq")]),t._v(" 账号进行配置后，并准备好你的插件，存入 "),s("code",[t._v("plugins")]),t._v(" 文件夹内，并遵守插件约定安装对应的依赖，进行要求的配置，即可进入 botoy 启动流程。")]),t._v(" "),s("h4",{attrs:{id:"启动-botoy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动-botoy"}},[t._v("#")]),t._v(" 启动 botoy")]),t._v(" "),s("p",[t._v("为了保证 botoy 后景存活，我们采用多窗口管理工具 tmux ：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装 tmux")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" update\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" tmux\n")])])]),s("p",[t._v("启动一个多窗口并运行 bot ：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启一个名为 bot 的多窗口")]),t._v("\n  tmux new -s bot\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 跳转至 botoy 启动文件夹内")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" ~/opqbot/client/botoy\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动 botoy")]),t._v("\n  python ./bot.py\n")])])]),s("p",[t._v("之后进行查错，确保连接 OPQ 本体正常、功能正常符合预期后，退出该窗口，常用快捷键如下：")]),t._v(" "),s("ul",[s("li",[s("p",[s("code",[t._v("ctrl")]),t._v(" + "),s("code",[t._v("b")]),t._v(" + "),s("code",[t._v("d")]),t._v(": 分离该窗口（退出该窗口，该窗口会持续在后景运行）")])]),t._v(" "),s("li",[s("p",[s("code",[t._v("ctrl")]),t._v(" + "),s("code",[t._v("b")]),t._v(" + "),s("code",[t._v("[")]),t._v(": 将窗口变的可以上下滚动，方便查看日志，使用 "),s("code",[t._v("ctrl")]),t._v(" + "),s("code",[t._v("c")]),t._v(" 退出滚动模式（正常情况不可上下滚动）")])])]),t._v(" "),s("p",[t._v("有关 tmux 的更多使用方法和操作快捷键，你可以在 "),s("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2019/10/tmux.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("此处(Tmux 使用教程)"),s("OutboundLink")],1),t._v(" 进一步学习")]),t._v(" "),s("h4",{attrs:{id:"操作-botoy"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#操作-botoy"}},[t._v("#")]),t._v(" 操作 botoy")]),t._v(" "),s("p",[t._v("当你需要 查看/重启 botoy 时，执行命令进入该后景窗口：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  tmux attach -t bot\n")])])]),s("p",[t._v("之后使用 "),s("code",[t._v("ctrl")]),t._v(" + "),s("code",[t._v("c")]),t._v(" 终止进程再重新运行即可。")]),t._v(" "),s("h2",{attrs:{id:"sio"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sio"}},[t._v("#")]),t._v(" Sio")]),t._v(" "),s("p",[t._v("正常情况你不需要阅读本节，若你有中转 botoy 使用其他语言的需求，或是使用了 "),s("a",{attrs:{href:"https://github.com/opq-osc/bot_sio_transfer",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("bot_sio_transfer")]),s("OutboundLink")],1),t._v(" 转发方案，可以参考本节。")]),t._v(" "),s("p",[t._v("我们这里以 "),s("a",{attrs:{href:"https://github.com/opq-osc/sio-yyy",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("sio-yyy")]),s("OutboundLink")],1),t._v(" 项目为例，我们约定 Sio 部分存放于 "),s("code",[t._v("sio/*")]),t._v(" ：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在 sio 文件夹下拉取项目")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://github.com/opq-osc/sio-yyy.git\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 确保你含有 nodejs 环境（安装略），安装前置依赖")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" config "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" registry http://registry.npm.taobao.org/\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -g "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pnpm")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pnpm")]),t._v(" i\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("pnpm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" -g pm2\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动项目")]),t._v("\n  pm2 start ./ecosystem.config.js\n")])])]),s("p",[t._v("之后该程序即可由 pm2 保活以 "),s("code",[t._v("yyy")]),t._v(" 的名称运行于后景，日常操作命令如下：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 查看全部 pm2 实时日志")]),t._v("\n  pm2 logs\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 停止 yyy")]),t._v("\n  pm2 stop yyy\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动 yyy")]),t._v("\n  pm2 start yyy\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 删除 yyy")]),t._v("\n  pm2 delete yyy\n")])])]),s("p",[t._v("当然，你还要遵守 "),s("code",[t._v("sio-yyy")]),t._v(" 的约定进行相应功能的配置才能使用，对于 botoy 侧，使用 "),s("code",[t._v("bot_sio_transfer")]),t._v(" 插件接收。")]),t._v(" "),s("h2",{attrs:{id:"end"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#end"}},[t._v("#")]),t._v(" End")]),t._v(" "),s("p",[t._v("本设定存在很多既定行为，仅仅作为参考使用，如果对你有帮助，或是你有更好的发想，欢迎加入我们亦或提出 PR ：")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://docs.opqbot.com/other/join.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Contact us"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("φ(≧ω≦*)♪")])])}),[],!1,null,null,null);a.default=r.exports}}]);